<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Figure 02: Scatterplot and Shift Summary for Quantitative Safety Measures Assessing High Value with Change Criteria: Individual Study</title>

  <!-- ✅ Quarto/Bootstrap assets (match index.html) -->
  <script src="site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="site_libs/quarto-nav/headroom.min.js"></script>
  <script src="site_libs/clipboard/clipboard.min.js"></script>
  <script src="site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="site_libs/quarto-search/fuse.min.js"></script>
  <script src="site_libs/quarto-search/quarto-search.js"></script>
  <meta name="quarto:offset" content="./">
  <script src="site_libs/quarto-html/quarto.js"></script>
  <script src="site_libs/quarto-html/popper.min.js"></script>
  <script src="site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="site_libs/quarto-html/anchor.min.js"></script>
  <link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <style>
    :root{font-family:Segoe UI, Roboto, system-ui, -apple-system, sans-serif;color:#222;}
    body{margin:0;padding:0;background:#f7f7fb;}
    .container{max-width:1100px;margin:100px auto 40px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 18px rgba(20,20,40,0.06);}
    h1{margin:0 0 6px;text-align:center;font-size:20px;}
    .subtitle{text-align:center;color:#444;margin-bottom:18px;font-size:14px;}

    /* code wrapper */
    .code-wrapper{position:relative;border:1px solid #e6e6e6;border-radius:8px;background:#f2f2f2;overflow:hidden;}
    .code-viewport{max-height:55vh;overflow:auto;padding:12px;font-family:"Fira Code", Consolas, monospace;font-size:13px;line-height:1.4;background:transparent;}
    .lines{min-width:min-content;}
    .line{display:flex;align-items:flex-start;gap:12px;white-space:pre;}
    .ln{width:60px;text-align:right;color:#666;user-select:none;flex:0 0 60px;padding-right:6px;}
    .content{flex:1 1 auto;white-space:pre;overflow:visible;color:#111;}

    /* Copy button */
    .copy-btn{position:absolute;top:8px;right:8px;z-index:3;padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:600;}
    .copy-btn:active{transform:translateY(1px);}

    /* image and buttons */
    .image-container{text-align:center;margin-top:16px;}
    .image-container img{max-width:100%;height:auto;border-radius:6px;border:1px solid #ddd;display:inline-block;}

    /* Wider Shiny app iframe */
    .image-container.wide-app {max-width:1400px; margin:0 auto;}
    .image-container.wide-app iframe {width:100%; height:800px; border:1px solid #ddd; border-radius:6px;}

    .buttons{text-align:center;margin-top:14px;}
    .buttons a.btn{display:inline-block;margin:6px;padding:10px 18px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none;font-weight:600;}
    .buttons a.btn:hover{background:#1e4db7;}

    footer{text-align:center;font-size:13px;color:#666;margin-top:18px;}

    @media(max-width:700px){
      .ln{width:48px;flex:0 0 48px;text-align:right;}
      .copy-btn{top:6px;right:6px;}
    }
  </style>

  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .navbar-custom {
      background-color: #003366; /* deep navy */
    }
    .navbar-custom .nav-link {
      font-size: 1.1rem;
      font-weight: 500;
      color: #ffffff;
    }
    .navbar-custom .nav-link:hover {
      color: #ffcc00;
    }
    .navbar-custom .dropdown-menu {
      background-color: #003366;
    }
    .navbar-custom .dropdown-item {
      color: #ffffff;
    }
    .navbar-custom .dropdown-item:hover {
      background-color: #002244;
      color: #ffcc00;
    }
  </style>

</head>
<body class="nav-fixed fullcontent">

<!-- ✅ Full navbar copied from index.html -->
  
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="./index.html">
      <img src="hepatotox-hex.png" alt="Hepatotox Logo" width="40" height="40" class="d-inline-block align-text-top">
      Hepatotox Catalog
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="./index.html">Home</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="articlesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Articles</a>
          <ul class="dropdown-menu" aria-labelledby="articlesDropdown">
            <li><a class="dropdown-item" href="./introduction.html">Introduction to Hepatotox</a></li>
            <li><a class="dropdown-item" href="./liver-enzyme.html">Liver Enzymes Overview</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="tablesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tables</a>
          <ul class="dropdown-menu" aria-labelledby="tablesDropdown">
            <li><a class="dropdown-item" href="./table01.html">Table 01</a></li>
            <li><a class="dropdown-item" href="./table02.html">Table 02</a></li>
            <li><a class="dropdown-item" href="./table03.html">Table 03</a></li>
            <li><a class="dropdown-item" href="./table04.html">Table 04</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="figuresDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Figures</a>
          <ul class="dropdown-menu" aria-labelledby="figuresDropdown">
            <li><a class="dropdown-item" href="./figure01.html">Figure 01</a></li>
            <li><a class="dropdown-item" href="./figure02.html">Figure 02</a></li>
            <li><a class="dropdown-item" href="./figure03.html">Figure 03</a></li>
            <li><a class="dropdown-item" href="./figure04.html">Figure 04</a></li>
            <li><a class="dropdown-item" href="./figure05.html">Figure 05</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="./resources.html">Resources</a></li>
      </ul>
    </div>
  </div>
</nav>


  <!-- ✅ Page content -->
  <div class="container">
    <h1>Figure 02: Scatterplot and Shift Summary for Quantitative Safety Measures Assessing High Value with Change Criteria: Individual Study</h1>
    <div class="subtitle">
      The datasets used for the program are modified versions of the <strong>ADLB.Rda & ADSL.Rda</strong> 
      from the <strong>random.cdisc.data</strong> library. Copy the code below to generate an interactive scatter plot and a shift summary table
assessing high value with change criteria.
    </div>

    <div class="code-wrapper" id="codeWrapper" aria-label="R program code area">
      <button class="copy-btn" id="copyBtn">Copy Code</button>
      <div class="code-viewport" id="codeViewport" tabindex="0" aria-label="R program scrollable code">
        <div class="lines" id="lines"></div>
      </div>
    </div>

    <p style="margin-top:20px;font-weight:600;">The generated output is below:</p>
    <div class="image-container wide-app">
      <iframe src="https://rxu6nu-dimple-patel.shinyapps.io/Figure2App/"></iframe>
    </div>

  </div>

  <!-- ✅ R code preserved -->
  <script id="rawCode" type="text/plain">
#Download appropriate libraries.
library(dplyr)
library(tern)
library(random.cdisc.data)
library(tidyverse)
library(magrittr)
library(rtables)
library(r2rtf)
library(formatters)
library(shiny)
library(plotly)
library(rlang)
library(gt)

#Load ADLB dataset.----
load(url("https://raw.githubusercontent.com/phuse-org/hepatotox/main/docs/data/adlbf2.Rda"))

#Load ADSL dataset.----
load(url("https://raw.githubusercontent.com/phuse-org/hepatotox/main/docs/data/adslf2.Rda"))

#NAs are explicit missing levels.----
adlb2aa <- df_explicit_na(adlbf2)
adsl2aa <- df_explicit_na(adslf2)

#Rename the treatment arms & parameter codes.----
levels(adlb2aa$ACTARMCD) <- c("T1", "PL", "T2")
levels(adlb2aa$ARM) <- c("Treatment 1", "Placebo", "Treatment 2")
levels(adlb2aa$PARAMCD) <- c("ALP", "ALT", "AST", "Total Bilirubin")
adlb2aa$PARAMCD <- factor(adlb2aa$PARAMCD, levels = c("ALT", "AST", "Total Bilirubin", "ALP"))
adlb2aa$PARAM <- factor(adlb2aa$PARAM, levels = c("Alanine Aminotransferase Measurement", "Aspartate Aminotransferase Measurement", "Total Bilirubin Measurement", "Alkaline Phosphatase Measurement"))

adlb2aa$ACTARMCD <- factor(adlb2aa$ACTARMCD, levels = c("T1", "T2", "PL"))
adlb2a <- adlb2aa %>% add_column(RUNNUM=runif(nrow(.)))

#Flag baseline measurement.----
adlb2bl <- adlb2a %>% filter(SAFFL == "Y" & ABLFL == "Y") %>%
  group_by(USUBJID, PARAMCD) %>% 
  select(USUBJID, SUBJID, PARAMCD, PARAM, ABLFL, BASE, ARMCD)

#Flag the maximum post-baseline result.----
adlb2mpbr <- adlb2a %>% filter(SAFFL == "Y" & AVISITN %in% c(1, 2)) %>%
  group_by(USUBJID, PARAMCD) %>% slice_max(AVAL) %>% mutate(MPBR = "Y")

#Merge Baseline Laboratory Dataset with the Maximum Post-Baseline Laboratory Dataset.----
adlb2shift <- merge(x = adlb2mpbr, y = adlb2bl[ , c("SUBJID", "USUBJID", "PARAMCD", "PARAM", "ABLFL", "BASE", "ARMCD")], by = c("SUBJID", "PARAMCD"), all.x = TRUE) %>%
  mutate(BASExr = round(BASE.x, 3), AVALr = round(AVAL, 3), BASEyr = round(BASE.y, 3))

#Create 2 event Flags. 1 for N = number of subjects with Max. Baseline 'normal' or
#'low' and at least 1 post-baseline value. 2nd flag for n = number of subjects with 
#Max post-baseline 'high'.----
adlb2flags <- adlb2shift %>% mutate(EVFLAG1 = case_when(ABLFL.y == "Y" & 
            BNRIND %in% c("LOW", "NORMAL") & MPBR == "Y" ~ "Y", .default = "N")) %>%
            mutate(EVFLAG2 = case_when(EVFLAG1 == "Y" & ANRIND %in% c("HIGH") ~ "Y", 
                                       EVFLAG1 == "Y" & ANRIND %in% c("LOW", "NORMAL") ~ "N"), .default ="N")


#Subset flagged table by parameter code.----
adlbflagsalt <- adlb2flags %>% filter(PARAMCD == "ALT")
adlbflagsast <- adlb2flags %>% filter(PARAMCD == "AST")
adlbflagstbili <- adlb2flags %>% filter(PARAMCD == "Total Bilirubin")
adlbflagsalp <- adlb2flags %>% filter(PARAMCD == "ALP")

#Create frequency tables with percentage for ALT/AST/Total Bilirubin/ALP.----
adlbflagsaltn1 <- adlbflagsalt %>% filter(EVFLAG1 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N1 = n())
adlbflagsastn1 <- adlbflagsast %>% filter(EVFLAG1 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N1 = n())
adlbflagstbilin1 <- adlbflagstbili %>% filter(EVFLAG1 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N1 = n())
adlbflagsalpn1 <- adlbflagsalp %>% filter(EVFLAG1 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N1 = n())

adlbflagsaltn2 <- adlbflagsalt %>% filter(EVFLAG2 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N2 = n())
adlbflagsastn2 <- adlbflagsast %>% filter(EVFLAG2 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N2 = n())
adlbflagstbilin2 <- adlbflagstbili %>% filter(EVFLAG2 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N2 = n())
adlbflagsalpn2 <- adlbflagsalp %>% filter(EVFLAG2 == "Y") %>% group_by(ACTARMCD) %>% 
  summarize(N2 = n())

adlbflagsalt2 <- merge(adlbflagsaltn2[ , c("ACTARMCD", "N2")], adlbflagsaltn1, by = c("ACTARMCD")) %>%   mutate(perc = round(N2/N1*100, 2)) 
adlbflagsast2 <- merge(adlbflagsastn2[ , c("ACTARMCD", "N2")], adlbflagsastn1, by = c("ACTARMCD")) %>%   mutate(perc = round(N2/N1*100, 2)) 
adlbflagstbili2 <- merge(adlbflagstbilin2[ , c("ACTARMCD", "N2")], adlbflagstbilin1, by = c("ACTARMCD")) %>%   mutate(perc = round(N2/N1*100, 2)) 
adlbflagsalp2 <- merge(adlbflagsalpn2[ , c("ACTARMCD", "N2")], adlbflagsalpn1, by = c("ACTARMCD")) %>%   mutate(perc = round(N2/N1*100, 2)) 

finalt <- rbind(adlbflagsalt2[2, ], adlbflagsalt2[3, ], adlbflagsalt2[1, ])
finast <- rbind(adlbflagsast2[2, ], adlbflagsast2[3, ], adlbflagsast2[1, ])
fintbili <- rbind(adlbflagstbili2[2, ], adlbflagstbili2[3, ], adlbflagstbili2[1, ])
finalp <- rbind(adlbflagsalp2[2, ], adlbflagsalp2[3, ], adlbflagsalp2[1, ])

#Create contingency tables to procure Fisher's exact test calculation for ALT/AST/Total #Bilirubin/ALP.----
contalt <- adlbflagsalt2 %>% mutate(nothigh = N1 - N2) %>% select(ACTARMCD, N2, nothigh)
contast <- adlbflagsast2 %>% mutate(nothigh = N1 - N2) %>% select(ACTARMCD, N2, nothigh)
conttbili <- adlbflagstbili2 %>% mutate(nothigh = N1 - N2) %>% select(ACTARMCD, N2, nothigh)
contalp <- adlbflagsalp2 %>% mutate(nothigh = N1 - N2) %>% select(ACTARMCD, N2, nothigh)

contaltt1 <- contalt %>% filter(ACTARMCD %in% c("PL", "T1"))
contastt1 <- contast %>% filter(ACTARMCD %in% c("PL", "T1"))
conttbilit1 <- conttbili %>% filter(ACTARMCD %in% c("PL", "T1"))
contalpt1 <- contalp %>% filter(ACTARMCD %in% c("PL", "T1"))

altfisht1 <- fisher.test(rbind(contaltt1[1, 2:3], contaltt1[2, 2:3]),  alternative="less")
astfisht1 <- fisher.test(rbind(contastt1[1, 2:3], contastt1[2, 2:3]),  alternative="less")
tbilifisht1 <- fisher.test(rbind(conttbilit1[1, 2:3], conttbilit1[2, 2:3]),  alternative="less")
alpfisht1 <- fisher.test(rbind(contalpt1[1, 2:3], contalpt1[2, 2:3]),  alternative="less")

contaltt2 <- contalt %>% filter(ACTARMCD %in% c("PL", "T2")) 
contastt2 <- contast %>% filter(ACTARMCD %in% c("PL", "T2"))
conttbilit2 <- conttbili %>% filter(ACTARMCD %in% c("PL", "T2"))
contalpt2 <- contalp %>% filter(ACTARMCD %in% c("PL", "T2"))

altfisht2 <- fisher.test(rbind(contaltt2[1, 2:3], contaltt2[2, 2:3]),  alternative="less")
astfisht2 <- fisher.test(rbind(contastt2[1, 2:3], contastt2[2, 2:3]),  alternative="less")
tbilifisht2 <- fisher.test(rbind(conttbilit2[1, 2:3], conttbilit2[2, 2:3]),  alternative="less")
alpfisht2 <- fisher.test(rbind(contalpt2[1, 2:3], contalpt2[2, 2:3]),  alternative="less")

#Add Fisher's Exact test values to original frequency tables ALT/AST/Total Bilirubin/ALP.----
pvalalt <- c(round(altfisht1$p.value, 2), round(altfisht2$p.value, 2), NA)
pvalast <- c(round(astfisht1$p.value, 2), round(astfisht2$p.value, 2), NA)
pvaltbili <- c(round(tbilifisht1$p.value, 2), round(tbilifisht2$p.value, 2), NA)
pvalalp <- c(round(alpfisht1$p.value, 2), round(alpfisht2$p.value, 2), NA)

finalt2 <- cbind(finalt, pvalalt)
finast2 <- cbind(finalt, pvalast)
fintbili2 <- cbind(fintbili, pvaltbili)
finalp2 <- cbind(finalt, pvalalp)

#Create crude GT table for each lab test.----
finalt2a <- finalt2 %>% gt() %>% 
  tab_spanner(label = "Treatment-Emergent High",  columns = c(N2, N1, perc, pvalalt), id = "dt") %>%
  cols_label(ACTARMCD = "Treatment", N2 = "N", N1 = "n", perc = "%", pvalalt = "P value*a")  

finast2a <- finast2 %>% gt() %>% 
  tab_spanner(label = "Treatment-Emergent High",  columns = c(N2, N1, perc, pvalast), id = "dt") %>%
  cols_label(ACTARMCD = "Treatment", N2 = "N", N1 = "n", perc = "%", pvalast = "P value*a")  

fintbili2a <- fintbili2 %>% gt() %>% 
  tab_spanner(label = "Treatment-Emergent High",  columns = c(N2, N1, perc, pvaltbili), id = "dt") %>% cols_label(ACTARMCD = "Treatment", N2 = "N", N1 = "n", perc = "%", pvaltbili = "P value*a")  

finalp2a <- finalp2 %>% gt() %>% 
  tab_spanner(label = "Treatment-Emergent High",  columns = c(N2, N1, perc, pvalalp), id = "dt") %>%
  cols_label(ACTARMCD = "Treatment", N2 = "N", N1 = "n", perc = "%", pvalalp = "P value*a")  

#Create & execute function to control appearance for rest of the features in the GT table.----  
gtrest <- function(dataset1) {
  dataset1 %>% tab_footnote("N = number of subjects with Max. baseline 'normal' or
'low' and at least one post-baselinevalue; n = among the 'N',
number of subjects with Max. post-baseline 'high'; high and low are determined
using the reference limits based on the individual subject's demographics.
*a - P values are from Fisher's Exact test, compared with PL.") %>%
  tab_options(table.font.size = 13) %>%
  tab_style(
    style = cell_borders(sides = "bottom", style = NULL),
    locations = cells_body(
      columns = 1:5,
      rows = 1:3
    )) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = c("top", "bottom"),  
        color = "black",  
        weight = px(2)  
      )
    ),
    locations = cells_column_spanners(spanners = everything())  
  ) %>%
  tab_style(
    style = list(
      cell_borders(
        sides = c("top", "bottom"),  
        color = "black", 
        weight = px(2)  
      )
    ),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_style(
    style = cell_borders(sides = "bottom", color = "black", weight = 2),
    locations = cells_body(
      columns = 1:5,
      rows = 3
    )) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_column_labels(columns = everything())
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_spanners(spanners = "dt")
  ) %>%
  tab_style(
    style = list(cell_text(weight = "bold")),
    locations = cells_body(columns = 1)
  )
}

finalt3 <- gtrest(finalt2a)
finast3 <- gtrest(finast2a)
fintbili3 <- gtrest(fintbili2a)
finalp3 <- gtrest(finalp2a)

#Create RShiny app's UI component----
uix <- fluidPage(
  fluidRow(
    column(12, 
           h3("Figure 2: Scatterplot and Shift Summary for Quantitative Safety Measures \n Assessing High Value with Change Criteria: Individual Study", style = "font-size: 20px;"),
           uiOutput("subtitles")
    )
  ),
  
  fluidRow(
  column(4, selectInput("Plot", "Please select a Liver Biochemical Test to view:",
           choices = c("ALT", "AST", "Total Bilirubin", "ALP"), width = '100%')),
  column(1, br(), actionButton("submit", "Submit", width = '100%')
  )),

  mainPanel(fluidRow(
  column(7, 
           plotlyOutput("Plots", height = "400px", width = '100%'),   
           textOutput("footnote1", container = span)  
    ),
    column(4, 
           gt_output("Tables")),
    tags$head(
    tags$style(HTML(HTML("
      #footnote1 {
        font-size: 10px;
      }
    "))
  )
)
)))

#Create RShiny app's Server Component. ----
server <- function(input, output, session) {
  observeEvent(input$submit, {
  plotalt <- plot_ly(adlb2shift %>% filter(ACTARMCD == "PL" & PARAMCD == "ALT"), 
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            name = "Placebo",
            marker = list(color = "aquamarine")) %>%
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T1" & PARAMCD == "ALT"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "lightslategray"),
            name = "Treatment 1") %>% 
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T2" & PARAMCD == "ALT"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "hotpink"),
            name = "Treatment 2") %>%
      layout(title = "Scatterplot of Baseline Versus Maximum Values for AST\n<Analysis Set>",
           xaxis = list(title = "Maximum Baseline Measures (Unit: U/L)"),
           yaxis = list(title = 'Max. Post-baseline Measures (Unit: U/L)'),
           legend=list(title=list(text='<b> Treatment </b>')),
           shapes = list(
    list(
        type = "line",
        x0 = 7,
        x1 = 7,
        y0 = 0,
        y1 = 67,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 55,
        x1 = 55,
        y0 = 0,
        y1 = 67,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 70,
        y0 = 7,
        y1 = 7,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 70,
        y0 = 55,
        y1 = 55,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line", 
        x0 = 0, 
        x1 = ~max(70, 70), 
        xref = "x",
        y0 = 0, 
        y1 = ~max(70, 70),
        yref = "y",
        line = list(color = "black")
    ))) %>%
    add_annotations(
      x= 56,
      y= 4.5,
      text = "ULN",
      showarrow = F,
      textangle = 270,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x= 4.5,
      y= 57,
      text = "ULN",
      showarrow = F,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x= 8,
      y= 4.5,
      text = "LLN",
      showarrow = F,
      textangle = 270,
      font = list(color = "blue")
    ) %>%
    add_annotations(
      x= 3.5,
      y= 8.5,
      text = "LLN",
      showarrow = F,
      font = list(color = "blue")
    ) 

  plotast <- plot_ly(adlb2shift %>% filter(ACTARMCD == "PL" & PARAMCD == "AST"), 
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            name = "Placebo",
            marker = list(color = "aquamarine")) %>%
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T1" & PARAMCD == "AST"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "lightslategray"),
            name = "Treatment 1") %>% 
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T2" & PARAMCD == "AST"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "hotpink"),
            name = "Treatment 2") %>%
    layout(title = "Scatterplot of Baseline Versus Maximum Values for AST\n<Analysis Set>",
           xaxis = list(title = "Maximum Baseline Measures (Unit: U/L)"),
           yaxis = list(title = 'Max. Post-baseline Measures (Unit: U/L)'),
           legend=list(title=list(text='<b> Treatment </b>')),
           shapes = list(
    list(
        type = "line",
        x0 = 8,
        x1 = 8,
        y0 = 0,
        y1 = 37,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 33,
        x1 = 33,
        y0 = 0,
        y1 = 37,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 45,
        y0 = 8,
        y1 = 8,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 45,
        y0 = 33,
        y1 = 33,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line", 
        x0 = 0, 
        x1 = ~max(38, 38), 
        xref = "x",
        y0 = 0, 
        y1 = ~max(38, 38),
        yref = "y",
        line = list(color = "black")
    ))) %>%
    add_annotations(
      x = 34,
      y = 6,
      text = "ULN",
      showarrow = F,
      textangle = 270,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x = 6,
      y = 34,
      text = "ULN",
      showarrow = F,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x = 9,
      y = 6,
      text = "LLN",
      showarrow = F,
      textangle = 270,
      font = list(color = "blue")
    ) %>%
    add_annotations(
      x = 6,
      y = 9,
      text = "LLN",
      showarrow = F,
      font = list(color = "blue")
    ) 

  plottbili <- plot_ly(adlb2shift %>% filter(ACTARMCD == "PL" & PARAMCD == "Total Bilirubin"), 
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            name = "Placebo",
            marker = list(color = "aquamarine")) %>%
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T1" & PARAMCD == "Total Bilirubin"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "lightslategray"),
            name = "Treatment 1") %>% 
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T2" & PARAMCD == "Total Bilirubin"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "hotpink"),
            name = "Treatment 2") %>%
    layout(title = list(text = "Scatterplot of Baseline Versus Maximum Values for Total Bilirubin\n<Analysis Set>", font = list(size = 14)),
           xaxis = list(title = "Maximum Baseline Measures (Unit: mg/dL)", ticks = "inside"),
           yaxis = list(title = "Max. Post-baseline Measures (Unit: mg/dL)", ticks = "inside"),
           legend=list(title=list(text='<b> Treatment </b>')),
           shapes = list(
    list(
        type = "line",
        x0 = .1,
        x1 = .1,
        y0 = 0,
        y1 = 3.5,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 1.2,
        x1 = 1.2,
        y0 = 0,
        y1 = 3.5,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 3.5,
        y0 = .1,
        y1 = .1,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 3.5,
        y0 = 1.2,
        y1 = 1.2,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line", 
        x0 = 0, 
        x1 = ~max(3.5, 3.5), 
        xref = "x",
        y0 = 0, 
        y1 = ~max(3.5, 3.5),
        yref = "y",
        line = list(color = "black")
    ))) %>%
    add_annotations(
      x= 1.25,
      y= .25,
      text = "ULN",
      showarrow = F,
      textangle = 270,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x= .27,
      y= 1.3,
      text = "ULN",
      showarrow = F,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x= .15,
      y= .5,
      text = "LLN",
      showarrow = F,
      textangle = 270,
      font = list(color = "blue")
    ) %>%
    add_annotations(
      x= .5,
      y= .2,
      text = "LLN",
      showarrow = F,
      font = list(color = "blue")
    ) 

  plotalp <- plot_ly(adlb2shift %>% filter(ACTARMCD == "PL" & PARAMCD == "ALP"), 
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            name = "Placebo",
            marker = list(color = "aquamarine")) %>%
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T1" & PARAMCD == "ALP"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "lightslategray"),
            name = "Treatment 1") %>% 
    add_trace(data = adlb2shift %>% filter(ACTARMCD == "T2" & PARAMCD == "ALP"),
            x = ~BASExr,
            y = ~AVALr,
            type = 'scatter', 
            color = ~ACTARMCD,
            symbol = ~ACTARMCD,
            mode = 'markers',
            marker = list(color = "hotpink"),
            name = "Treatment 2") %>%
    layout(title = "Scatterplot of Baseline Versus Maximum Values for ALP\n<Analysis Set>",
           xaxis = list(title = "Maximum Baseline Measures (Unit: U/L)"),
           yaxis = list(title = 'Max. Post-baseline Measures (Unit: U/L)'),
           legend=list(title=list(text='<b> Treatment </b>')),
           shapes = list(
    list(
        type = "line",
        x0 = 44,
        x1 = 44,
        y0 = 0,
        y1 = 250,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 147,
        x1 = 147,
        y0 = 0,
        y1 = 250,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 250,
        y0 = 44,
        y1 = 44,
        line = list(color = "blue", dash = "dash")
      ),
    list(
        type = "line",
        x0 = 0,
        x1 = 250,
        y0 = 147,
        y1 = 147,
        line = list(color = "darkred", dash = "dash")
      ),
    list(
        type = "line", 
        x0 = 0, 
        x1 = ~max(250, 250), 
        xref = "x",
        y0 = 0, 
        y1 = ~max(250, 250),
        yref = "y",
        line = list(color = "black")
    ))) %>%
    add_annotations(
      x= 150,
      y= 34,
      text = "ULN",
      showarrow = F,
      textangle = 270,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x= 34,
      y= 153,
      text = "ULN",
      showarrow = F,
      font = list(color = "red")
    ) %>%
    add_annotations(
      x= 47,
      y= 34,
      text = "LLN",
      showarrow = F,
      textangle = 270,
      font = list(color = "blue")
    ) %>%
    add_annotations(
      x= 34,
      y= 48,
      text = "LLN",
      showarrow = F,
      font = list(color = "blue")
    ) 

    output$subtitles <- renderUI({
    switch(isolate(input$Plot),
      "ALT" = HTML(paste("Scatterplot and Shift Table Summary of Absolute Lab Values for ALT",
      "Max baseline vs. Max Post-baseline",  sep="<br/>")),
      "AST" = HTML(paste("Scatterplot and Shift Table Summary of Absolute Lab Values for AST
      Max baseline vs. Max Post-baseline",  sep="<br/>")),
      "Total Bilirubin" = HTML(paste("Scatterplot and Shift Table Summary of Absolute Lab Values for Total Bilirubin Max baseline vs. Max Post-baseline",  sep="<br/>")),
      "ALP" = HTML(paste("Scatterplot and Shift Table Summary of Absolute Lab Values for ALP
      Max baseline vs. Max Post-baseline",  sep="<br/>")))
  })
    
    output$footnote1 <- renderText({
        HTML("LLN=Lower limit of normal; ULN=Upper limit of normal; if the limits (LLN and ULN) vary across the population, the limits that apply to the majority of subjects are displayed in the scatter plot.The black diagonal line represents no change from max. baseline to max. post-baseline.")
      })
    
    output$Plots = renderPlotly({
    switch(isolate(input$Plot),
           "ALT" = plotalt,
           "AST" = plotast,
           "Total Bilirubin" = plottbili,
           "ALP" = plotalp
          )
    })
    
    output$Tables = render_gt({
    switch(isolate(input$Plot),
           "ALT" = finalt3,
           "AST" = finast3,
           "Total Bilirubin" = fintbili3,
           "ALP" = finalp3
          )
    })
})}

#Output final ShinyApp.
shinyApp(uix, server)
  </script>

  <script>
    (function(){
      let raw = document.getElementById('rawCode').textContent.replace(/\r/g, '').replace(/^\n+/, '').replace(/\n+$/, '');
      const linesArray = raw.split('\n');
      const linesContainer = document.getElementById('lines');
      const frag = document.createDocumentFragment();
      linesArray.forEach((text, idx) => {
        const row = document.createElement('div'); row.className='line';
        const ln = document.createElement('div'); ln.className='ln'; ln.textContent = idx+1;
        const content = document.createElement('div'); content.className='content'; content.textContent=text;
        row.appendChild(ln); row.appendChild(content); frag.appendChild(row);
      });
      linesContainer.appendChild(frag);

      document.getElementById('copyBtn').addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(raw);
          let b=document.getElementById('copyBtn');
          b.textContent='Copied!';
          setTimeout(()=>b.textContent='Copy Code',1200);
        } catch(e) {
          alert('Copy failed');
        }
      });
    })();
  </script>
</body>
</html>
