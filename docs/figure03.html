<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Figure 03: Line Plot for Liver Biochemical Tests</title>

  <!-- ✅ Quarto/Bootstrap assets (match index.html) -->
  <script src="site_libs/quarto-nav/quarto-nav.js"></script>
  <script src="site_libs/quarto-nav/headroom.min.js"></script>
  <script src="site_libs/clipboard/clipboard.min.js"></script>
  <script src="site_libs/quarto-search/autocomplete.umd.js"></script>
  <script src="site_libs/quarto-search/fuse.min.js"></script>
  <script src="site_libs/quarto-search/quarto-search.js"></script>
  <meta name="quarto:offset" content="./">
  <script src="site_libs/quarto-html/quarto.js"></script>
  <script src="site_libs/quarto-html/popper.min.js"></script>
  <script src="site_libs/quarto-html/tippy.umd.min.js"></script>
  <script src="site_libs/quarto-html/anchor.min.js"></script>
  <link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
  <link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet">
  <script src="site_libs/bootstrap/bootstrap.min.js"></script>
  <link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
  <link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <style>
    :root{font-family:Segoe UI, Roboto, system-ui, -apple-system, sans-serif;color:#222;}
    body{margin:0;padding:0;background:#f7f7fb;}
    .container{max-width:1100px;margin:100px auto 40px;background:#fff;border-radius:10px;padding:20px;box-shadow:0 6px 18px rgba(20,20,40,0.06);}
    h1{margin:0 0 6px;text-align:center;font-size:16px;}
    .subtitle{text-align:center;color:#444;margin-bottom:18px;font-size:14px;}

    /* code wrapper */
    .code-wrapper{position:relative;border:1px solid #e6e6e6;border-radius:8px;background:#f2f2f2;overflow:hidden;}
    .code-viewport{max-height:55vh;overflow:auto;padding:12px;font-family:"Fira Code", Consolas, monospace;font-size:13px;line-height:1.4;background:transparent;}
    .lines{min-width:min-content;}
    .line{display:flex;align-items:flex-start;gap:12px;white-space:pre;}
    .ln{width:60px;text-align:right;color:#666;user-select:none;flex:0 0 60px;padding-right:6px;}
    .content{flex:1 1 auto;white-space:pre;overflow:visible;color:#111;}

    /* Copy button */
    .copy-btn{position:absolute;top:8px;right:8px;z-index:3;padding:6px 10px;border-radius:6px;border:0;background:#2563eb;color:#fff;cursor:pointer;font-weight:600;}
    .copy-btn:active{transform:translateY(1px);}

    /* image and buttons */
    .image-container{text-align:center;margin-top:16px;}
    .image-container img{max-width:100%;height:auto;border-radius:6px;border:1px solid #ddd;display:inline-block;}

    /* Wider Shiny app iframe */
    .image-container.wide-app {max-width:1400px; margin:0 auto;}
    .image-container.wide-app iframe {width:100%; height:800px; border:1px solid #ddd; border-radius:6px;}

    .buttons{text-align:center;margin-top:14px;}
    .buttons a.btn{display:inline-block;margin:6px;padding:10px 18px;border-radius:8px;background:#2563eb;color:#fff;text-decoration:none;font-weight:600;}
    .buttons a.btn:hover{background:#1e4db7;}

    footer{text-align:center;font-size:13px;color:#666;margin-top:18px;}

    @media(max-width:700px){
      .ln{width:48px;flex:0 0 48px;text-align:right;}
      .copy-btn{top:6px;right:6px;}
    }
  </style>

  <!-- Bootstrap CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    .navbar-custom {
      background-color: #003366; /* deep navy */
    }
    .navbar-custom .nav-link {
      font-size: 1.1rem;
      font-weight: 500;
      color: #ffffff;
    }
    .navbar-custom .nav-link:hover {
      color: #ffcc00;
    }
    .navbar-custom .dropdown-menu {
      background-color: #003366;
    }
    .navbar-custom .dropdown-item {
      color: #ffffff;
    }
    .navbar-custom .dropdown-item:hover {
      background-color: #002244;
      color: #ffcc00;
    }
  </style>

</head>
<body class="nav-fixed fullcontent">

<!-- ✅ Full navbar copied from index.html -->
  
<nav class="navbar navbar-expand-lg navbar-dark navbar-custom">
  <div class="container-fluid">
    <a class="navbar-brand" href="./index.html">
      <img src="hepatotox-hex.png" alt="Hepatotox Logo" width="40" height="40" class="d-inline-block align-text-top">
      Hepatotox Catalog
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
      aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="./index.html">Home</a></li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="articlesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Articles</a>
          <ul class="dropdown-menu" aria-labelledby="articlesDropdown">
            <li><a class="dropdown-item" href="./introduction.html">Introduction to Hepatotox</a></li>
            <li><a class="dropdown-item" href="./liver-enzyme.html">Liver Enzymes Overview</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="tablesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Tables</a>
          <ul class="dropdown-menu" aria-labelledby="tablesDropdown">
            <li><a class="dropdown-item" href="./table01.html">Table 01</a></li>
            <li><a class="dropdown-item" href="./table02.html">Table 02</a></li>
            <li><a class="dropdown-item" href="./table03.html">Table 03</a></li>
            <li><a class="dropdown-item" href="./table04.html">Table 04</a></li>
          </ul>
        </li>
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="figuresDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">Figures</a>
          <ul class="dropdown-menu" aria-labelledby="figuresDropdown">
            <li><a class="dropdown-item" href="./figure01.html">Figure 01</a></li>
            <li><a class="dropdown-item" href="./figure02.html">Figure 02</a></li>
            <li><a class="dropdown-item" href="./figure03.html">Figure 03</a></li>
            <li><a class="dropdown-item" href="./figure04.html">Figure 04</a></li>
            <li><a class="dropdown-item" href="./figure05.html">Figure 05</a></li>
          </ul>
        </li>
        <li class="nav-item"><a class="nav-link" href="./resources.qmd">Resources</a></li>
      </ul>
    </div>
  </div>
</nav>


  <!-- ✅ Page content -->
  <div class="container">
    <h1>Figure 03: Line Plot for Liver Biochemical Tests</h1>
    <div class="subtitle">
      The datasets used for the program are modified versions of the <strong>ADLB.Rda & ADSL.Rda</strong> 
      from the <strong>random.cdisc.data</strong> library. Copy the code below to generate an interactive line plot for liver biochemical tests.
    </div>

    <div class="code-wrapper" id="codeWrapper" aria-label="R program code area">
      <button class="copy-btn" id="copyBtn">Copy Code</button>
      <div class="code-viewport" id="codeViewport" tabindex="0" aria-label="R program scrollable code">
        <div class="lines" id="lines"></div>
      </div>
    </div>

    <p style="margin-top:20px;font-weight:600;">The generated output is below:</p>
    <div class="image-container wide-app">
      <iframe src="https://rxu6nu-dimple-patel.shinyapps.io/fig3_app/"></iframe>
    </div>

  </div>

  <!-- ✅ R code preserved -->
  <script id="rawCode" type="text/plain">
#Download appropriate libraries.
library(dplyr)
library(tern)
library(random.cdisc.data)
library(tidyverse)
library(magrittr)
library(formatters)
library(grid)
library(shiny)
library(plotly)
library(ggvis)
library(patchwork)
library(ggprism)
library(maditr)
library(gridExtra)
library(utile.visuals)
library(flextable)
library(cowplot)
library(sciplot)
library(DT)
library(gt)

#Load ADLB dataset.----
load(url("https://raw.githubusercontent.com/phuse-org/hepatotox/main/docs/data/adlbf3.Rda"))

#Load ADSL dataset.----
load(url("https://raw.githubusercontent.com/phuse-org/hepatotox/main/docs/data/adslf3.Rda"))

#NAs are explicit missing levels.----
adlb2aa <- df_explicit_na(adlbf3)

#Rename the treatment arms & parameter codes.----
levels(adlb2aa$ACTARMCD) <- c("T1", "PL", "T2")
levels(adslf3$ACTARMCD) <- c("T1", "PL", "T2")
levels(adlb2aa$ARM) <- c("Treatment 1", "Placebo", "Treatment 2")
levels(adlb2aa$PARAMCD) <- c("ALP", "ALT", "AST", "TBILI")
adlb2aa$PARAMCD <- factor(adlb2aa$PARAMCD, levels = c("ALT", "AST", "TBILI", "ALP"))
adlb2aa$PARAM <- factor(adlb2aa$PARAM, levels = c("Alanine Aminotransferase Measurement", "Aspartate Aminotransferase Measurement", "Total Bilirubin Measurement", "Alkaline Phosphatase Measurement"))
adlb2aa$ACTARMCD <- factor(adlb2aa$ACTARMCD, levels = c("PL", "T1", "T2")) 
adslf3$ACTARMCD <- factor(adslf3$ACTARMCD, levels = c("PL", "T1", "T2")) 
adlb2a <- adlb2aa %>% add_column(RUNNUM=runif(nrow(.)))

#Fix the visit values to align figure shell's visit values.----
adlb2a1 <- adlb2a %>% mutate(WKVISIT = case_when(AVISIT %in% c("BASELINE") ~ "Baseline", AVISIT %in%
  "WEEK 1 DAY 8" ~ "Week 1", AVISIT %in% c("WEEK 2 DAY 15")~"Week 2", AVISIT %in% c("WEEK 3 DAY 22") ~ "Week 3", AVISIT %in% c("WEEK 4 DAY 29") ~ "Week 4", AVISIT %in% c("WEEK 5 DAY 36") ~ "Week 5",
  AVISIT %in% c("WEEK 6 DAY 43") ~ "Week 6", AVISIT %in% c("SCREENING") ~ "Screening",
  AVISIT %in% c("WEEK 7 DAY 50") ~ "Week 7", AVISIT %in% c("WEEK 8 DAY 57") ~ "Week 8",
  AVISIT %in% c("WEEK 9 DAY 64") ~ "Week 9", AVISIT %in% c("WEEK 10 DAY 71") ~ "Week 10", AVISIT %in% c("WEEK 11 DAY 78") ~ "Week 11", AVISIT %in% c("WEEK 12 DAY 85") ~ "Week 12", AVISIT %in% c("WEEK 13 DAY 92") ~ "Week 13", AVISIT %in% c("WEEK 14 DAY 99") ~ "Week 14", AVISIT %in% c("WEEK 15 DAY 106") ~ "Week 15", AVISIT %in% c("WEEK 16 DAY 113") ~ "Week 16", AVISIT %in% c("WEEK 17 DAY 120") ~ "Week 17", AVISIT %in% c("WEEK 18 DAY 127") ~ "Week 18", AVISIT %in% c("WEEK 19 DAY 134") ~ "Week 19", AVISIT %in% c("WEEK 20 DAY 141") ~ "Week 20", AVISIT %in% c("WEEK 21 DAY 148") ~ "Week 21", AVISIT %in% c("WEEK 22 DAY 155") ~ "Week 22", AVISIT %in% c("WEEK 23 DAY 162") ~ "Week 23", AVISIT %in% c("WEEK 24 DAY 169") ~ "Week 24", AVISIT %in% c("WEEK 25 DAY 176") ~ "Week 25", AVISIT %in% c("WEEK 26 DAY 183") ~ "Week 26")) %>%
  mutate(PERBASE = (case_when(AVISITN > 1 ~ AVAL - BASE))) 
  
#Subset table by parameter code & remove screening and baseline values.----
adlbalt <- adlb2a1 %>% filter(PARAMCD == "ALT" & AVISITN > 0)
adlbast <- adlb2a1 %>% filter(PARAMCD == "AST" & AVISITN > 0)
adlbtbili <- adlb2a1 %>% filter(PARAMCD == "TBILI" & AVISITN > 0)
adlbalp <- adlb2a1 %>% filter(PARAMCD == "ALP" & AVISITN > 0)

#Subset table by ACTARMCD.----
adlbaltt1 <- adlbalt %>% filter(ACTARMCD == "T1")
adlbaltt2 <- adlbalt %>% filter(ACTARMCD == "T2")
adlbaltpl <- adlbalt %>% filter(ACTARMCD == "PL")

adlbastt1 <- adlbast %>% filter(ACTARMCD == "T1")
adlbastt2 <- adlbast %>% filter(ACTARMCD == "T2")
adlbastpl <- adlbast %>% filter(ACTARMCD == "PL")

adlbtbilit1 <- adlbtbili %>% filter(ACTARMCD == "T1")
adlbtbilit2 <- adlbtbili %>% filter(ACTARMCD == "T2")
adlbtbilipl <- adlbtbili %>% filter(ACTARMCD == "PL")

adlbalpt1 <- adlbalp %>% filter(ACTARMCD == "T1")
adlbalpt2 <- adlbalp %>% filter(ACTARMCD == "T2")
adlbalppl <- adlbalp %>% filter(ACTARMCD == "PL")

#Create function to calculate mean change from baseline & SD of mean change from baseline.----
meanandSD <- function(dataset1, armcode1){
  dataset1 %>% group_by(ACTARMCD) %>% group_by(WKVISIT) %>% 
  summarize(PERBASEavg = mean(PERBASE), SDavg = sd(PERBASE)) %>% mutate(ARMCODE = armcode1)
}

#Execute meanandSD function for each PARMACD & Treatment Arm combo.
adlbaltmt1 <- meanandSD(adlbaltt1, "T1")
adlbaltmt2 <- meanandSD(adlbaltt2, "T2")
adlbaltmpl <- meanandSD(adlbaltpl, "PL")

adlbastmt1 <- meanandSD(adlbastt1, "T1")
adlbastmt2 <- meanandSD(adlbastt2, "T2")
adlbastmpl <- meanandSD(adlbastpl, "PL")

adlbtbilimt1 <- meanandSD(adlbtbilit1, "T1")
adlbtbilimt2 <- meanandSD(adlbtbilit2, "T2")
adlbtbilimpl <- meanandSD(adlbtbilipl, "PL")

adlbalpmt1 <- meanandSD(adlbalpt1, "T1")
adlbalpmt2 <- meanandSD(adlbalpt2, "T2")
adlbalpmpl <- meanandSD(adlbalppl, "PL")

#Create & execute function to calculate mean value at each visit----
meanvisit <- function(dataset1, armcode1){
  dataset1 %>% group_by(ACTARMCD) %>% group_by(WKVISIT) %>% 
  summarize(meanvisit = mean(AVAL)) %>%  mutate(ARMCODE = armcode1) %>%
  mutate(meanvisitrd = round(meanvisit, 2)) %>% 
  select(WKVISIT, ARMCODE, meanvisitrd)
}

adlbaltvt1 <- meanvisit(adlbaltt1, "T1")
adlbaltvt2 <- meanvisit(adlbaltt2, "T2")
adlbaltvpl <- meanvisit(adlbaltpl, "PL")

adlbastvt1 <- meanvisit(adlbastt1, "T1")
adlbastvt2 <- meanvisit(adlbastt2, "T2")
adlbastvpl <- meanvisit(adlbastpl, "PL")

adlbtbilivt1 <- meanvisit(adlbtbilit1, "T1")
adlbtbilivt2 <- meanvisit(adlbtbilit2, "T2")
adlbtbilivpl <- meanvisit(adlbtbilipl, "PL")

adlbalpvt1 <- meanvisit(adlbalpt1, "T1")
adlbalpvt2 <- meanvisit(adlbalpt2, "T2")
adlbalpvpl <- meanvisit(adlbalppl, "PL")

#Create and execute function to stack tables based on PARAMCD & filter table to pertinent weeks.----
bindweeks <- function(ds1, ds2, ds3) {
  bind_rows(ds1, ds2, ds3) %>% 
  filter(WKVISIT %in% c("Week 2", "Week 4", "Week 6", "Week 8", "Week 10", "Week 12", 
"Week 14", "Week 16", "Week 18", "Week 20", "Week 22", "Week 24", "Week 26"))
}

adlbaltfin <- bindweeks(adlbaltmt1, adlbaltmt2, adlbaltmpl) 
adlbastfin <- bindweeks(adlbastmt1, adlbastmt2, adlbastmpl) 
adlbtbilifin <- bindweeks(adlbtbilimt1, adlbtbilimt2, adlbtbilimpl) 
adlbalpfin <- bindweeks(adlbalpmt1, adlbalpmt2, adlbalpmpl)

adlbaltfinv <- bindweeks(adlbaltvt1, adlbaltvt2, adlbaltvpl) 
adlbastfinv <- bindweeks(adlbastvt1, adlbastvt2, adlbastvpl)
adlbtbilifinv <- bindweeks(adlbtbilivt1, adlbtbilivt2, adlbtbilivpl) 
adlbalpfinv <- bindweeks(adlbalpvt1, adlbalpvt2, adlbalpvpl)
  
#Reorder Weekly Visits.----
reordervisit <- function(dataset1) {
  factor(dataset1$WKVISIT, levels = c("Week 2", "Week 4", "Week 6", "Week 8", 
"Week 10", "Week 12", "Week 14", "Week 16", "Week 18", "Week 20", "Week 22", "Week 24", "Week 26"))
}

adlbaltfin$WKVISIT <- reordervisit(adlbaltfin)
adlbastfin$WKVISIT <- reordervisit(adlbastfin)
adlbtbilifin$WKVISIT <- reordervisit(adlbtbilifin)
adlbalpfin$WKVISIT <- reordervisit(adlbalpfin)

adlbaltfinv$WKVISIT <- reordervisit(adlbaltfinv)
adlbastfinv$WKVISIT <- reordervisit(adlbastfinv)
adlbtbilifinv$WKVISIT <- reordervisit(adlbtbilifinv)
adlbalpfinv$WKVISIT <- reordervisit(adlbalpfinv)

#Create function to round Mean Change from Baseline in dataset & merge with mean value data set.
#Then concatenate mean change from baseline with mean value. Then transpose.----
toptable <- function(dataset1, dataset2) {
  dataset1a <- dataset1 %>% mutate(MCFB = round(PERBASEavg, 2)) %>% 
  select(WKVISIT, ARMCODE, MCFB)
  
  dataset3 <- merge(dataset1a, dataset2, by.x = c("WKVISIT", "ARMCODE")) %>%
  mutate(meanchgvisit = paste(MCFB, "/", meanvisitrd, sep = "")) %>%
  select(ARMCODE, meanchgvisit, WKVISIT) %>%
  mutate(ARM = case_when(ARMCODE %in% c("PL") ~ "Placebo", ARMCODE %in% c("T1") ~
                           "Treatment 1", ARMCODE %in% c("T2") ~ "Treatment 2"))
  
  dataset3$ARMCODE <- factor(dataset3$ARMCODE, levels = c("PL", "T1", "T2")) 
  
  dataset3$WKVISIT <- factor(dataset3$WKVISIT, levels = c("Week 2", "Week 4", "Week 6", "Week 8", "Week 10", "Week 12", "Week 14", "Week 16", "Week 18", "Week 20", "Week 22", "Week 24", "Week 26"))
  
  dataset3a <- dataset3 %>% arrange(ARMCODE, WKVISIT)
  
  pivot_wider(dataset3a, names_from = WKVISIT, values_from = meanchgvisit) %>% select(-ARMCODE)
}

topaltfinwide <- toptable(adlbaltfin, adlbaltfinv)
topastfinwide <- toptable(adlbastfin, adlbastfinv)
toptbilifinwide <- toptable(adlbtbilifin, adlbtbilifinv)
topalpfinwide <- toptable(adlbalpfin, adlbalpfinv)

#Create GT Baseline/Mean Value tables for RShiny output.
finalgt <- function(dataset1, subtitle2) {
dataset1 %>%
  gt() %>%
  tab_options(column_labels.hidden = TRUE) %>%
  tab_style(
    style = cell_borders(sides = "bottom", color = "black", weight = 2),
    locations = cells_body(
      columns = 2:14,
      rows = 3
    ))  %>%
  tab_style(
    style = cell_borders(sides = "right", color = "black", weight = 2),
    locations = cells_body(
      columns = 14,
      rows = 1:3
    )) %>%
  tab_style(
    style = cell_borders(sides = "right", color = "black", weight = 2),
    locations = cells_body(
      columns = 1,
      rows = 1:3
    )) %>%
  tab_style(
    style = cell_borders(sides = "bottom", style = NULL),
    locations = cells_body(
      columns = 2:14,
      rows = 1:2
    )) %>%
  tab_style(
    style = cell_borders(sides = "top", style = NULL),
    locations = cells_body(
      columns = 1,
      rows = 1
    )) %>%
  tab_style(
    style = cell_borders(sides = "bottom", style = NULL),
    locations = cells_body(
      columns = 1,
      rows = 1:3
    )) %>%
  tab_style(
    style = cell_borders(sides = "top", color = "black", weight = 2),
    locations = cells_body(
      columns = 2:14,
      rows = 1
    )) %>%
  tab_style(
    style = cell_text(color = "steelblue"),  
    locations = cells_body(
      columns = 1:14,
      rows = 1
    )) %>%
  tab_style(
    style = cell_text(color = "blue"),
    locations = cells_body(
      columns = 1:14,
      rows = 2
    )) %>%
  tab_style(
    style = cell_text(color = "darkolivegreen4"),
    locations = cells_body(
      columns = 1:14,
      rows = 3
    )) %>%
  tab_header(
    title = "", 
    subtitle = subtitle2
  ) %>%
  cols_width(c("Week 2", "Week 4", "Week 6", "Week 8", "Week 10", "Week 12", 
    "Week 14", "Week 16", "Week 18", "Week 20", "Week 22", "Week 24", "Week 26") ~ px(150)) %>%
    tab_options(
    table.font.size = "8px" 
    )
}

finalalttop <- finalgt(topaltfinwide, "Mean Change from Baseline / Mean Value")
finalasttop <- finalgt(topastfinwide, "Mean Change from Baseline / Mean Value")
finaltbilitop <- finalgt(toptbilifinwide, "Mean Change from Baseline / Mean Value")
finalalptop <- finalgt(topalpfinwide, "Mean Change from Baseline / Mean Value")

#Create and execute function to calculate number of patients with data for each weekly visit.
countn <- function(dataset1, armcode1){
  dataset1 %>% group_by(ACTARMCD) %>% group_by(WKVISIT) %>% 
  summarize(npat = n()) %>% mutate(ARMCODE = armcode1)
}

adlbaltnt1 <- countn(adlbaltt1, "T1")
adlbaltnt2 <- countn(adlbaltt2, "T2")
adlbaltnpl <- countn(adlbaltpl, "PL")

adlbastnt1 <- countn(adlbastt1, "T1")
adlbastnt2 <- countn(adlbastt2, "T2")
adlbastnpl <- countn(adlbastpl, "PL")

adlbtbilint1 <- countn(adlbtbilit1, "T1")
adlbtbilint2 <- countn(adlbtbilit2, "T2")
adlbtbilinpl <- countn(adlbtbilipl, "PL")

adlbalpnt1 <- countn(adlbalpt1, "T1")
adlbalpnt2 <- countn(adlbalpt2, "T2")
adlbalpnpl <- countn(adlbalppl, "PL")

#Execute function to stack patient count tables based on PARAMCD & filter table to pertinent #weeks.----
adlbaltfinn <- bindweeks(adlbaltnt1, adlbaltnt2, adlbaltnpl) 
adlbastfinn <- bindweeks(adlbastnt1, adlbastnt2, adlbastnpl)
adlbtbilifinn <- bindweeks(adlbtbilint1, adlbtbilint2, adlbtbilinpl) 
adlbalpfinn <- bindweeks(adlbalpnt1, adlbalpnt2, adlbalpnpl)

#Create function to add space padding to patient number cells & transpose tables.----
bottable <- function(dataset1) {
  dataset2 <- dataset1 %>% select(ARMCODE, npat, WKVISIT) %>%
  mutate(ARM = case_when(ARMCODE %in% c("PL") ~ "Placebo", ARMCODE %in% c("T1") ~
                           "Treatment 1", ARMCODE %in% c("T2") ~ "Treatment 2")) %>% 
  mutate(npat2 = paste("     ", npat, "     ", sep = ""))
  
  dataset2$ARMCODE <- factor(dataset2$ARMCODE, levels = c("PL", "T1", "T2")) 
  
  dataset2$WKVISIT <- factor(dataset2$WKVISIT, levels = c("Week 2", "Week 4", "Week 6", "Week 8", "Week 10", "Week 12", "Week 14", "Week 16", "Week 18", "Week 20", "Week 22", "Week 24", "Week 26"))
  
  dataset2a <- dataset2 %>% arrange(ARMCODE, WKVISIT)
  
  pivot_wider(dataset2a, names_from = WKVISIT, values_from = npat2) %>% select(-ARMCODE, -npat)
}

botaltfinwide <- bottable(adlbaltfinn)
botastfinwide <- bottable(adlbastfinn)
bottbilifinwide <- bottable(adlbtbilifinn)
botalpfinwide <- bottable(adlbalpfinn)

#Create GT Patient Count tables for RShiny output via custom function finalgtbot().
finalgtbot <- function(dataset1, subtitle2) {
  dataset1 %>%
    gt() %>%
    tab_options(column_labels.hidden = TRUE) %>%
    tab_style(
      style = cell_borders(sides = "bottom", color = "black", weight = 2),
      locations = cells_body(
        columns = 2:14,
        rows = 3
      ))  %>%
    tab_style(
      style = cell_borders(sides = "right", color = "black", weight = 2),
      locations = cells_body(
        columns = 14,
        rows = 1:3
      )) %>%
    tab_style(
      style = cell_borders(sides = "right", color = "black", weight = 2),
      locations = cells_body(
        columns = 1,
        rows = 1:3
      )) %>%
    tab_style(
      style = cell_borders(sides = "bottom", style = NULL),
      locations = cells_body(
        columns = 2:14,
        rows = 1:2
      )) %>%
    tab_style(
      style = cell_borders(sides = "top", style = NULL),
      locations = cells_body(
        columns = 1,
        rows = 1
      )) %>%
    tab_style(
      style = cell_borders(sides = "bottom", style = NULL),
      locations = cells_body(
        columns = 1,
        rows = 1:3
      )) %>%
    tab_style(
      style = cell_borders(sides = "top", color = "black", weight = 2),
      locations = cells_body(
        columns = 2:14,
        rows = 1
      )) %>%
    tab_style(
      style = cell_text(color = "steelblue"),  
      locations = cells_body(
        columns = 1:14,
        rows = 1
      )) %>%
    tab_style(
      style = cell_text(color = "blue"),
      locations = cells_body(
        columns = 1:14,
        rows = 2
      )) %>%
    tab_style(
      style = cell_text(color = "darkolivegreen4"),
      locations = cells_body(
        columns = 1:14,
        rows = 3
      )) %>%
    tab_header(
      title = "", 
      subtitle = subtitle2
    )  %>%
    cols_width(c("Week 2", "Week 4", "Week 6", "Week 8", "Week 10", "Week 12", 
    "Week 14", "Week 16", "Week 18", "Week 20", "Week 22", "Week 24", "Week 26") ~ px(210)) %>%
    tab_options(
    table.font.size = "12px" 
    )
}
 
finalaltbot <- finalgtbot(botaltfinwide, "Number of Patients with Data")
finalastbot <- finalgtbot(botastfinwide, "Number of Patients with Data")
finaltbilibot <- finalgtbot(bottbilifinwide, "Number of Patients with Data")
finalalpbot <- finalgtbot(botalpfinwide, "Number of Patients with Data")
 
#Create RShiny app UI/server components.----
ui <- fluidPage(
  tags$style(HTML("
    .plot-container {
      margin-left: 20px;
    }
    .gt_table {
      width: 270%;
    }
  ")),
  titlePanel("Figure 3: Line Plot for Liver Biochemical Tests"),
  sidebarLayout(
    sidebarPanel(
     selectInput("Plot", "Please select a Liver Biochemical Test to view:",
      choices = c("ALT", "AST", "Total Bilirubin", "ALP")),
      actionButton("submit", "Submit"), width = 1.5),
    
    mainPanel(
    column(12,
           div(class = "plot-container", plotOutput("linePlot")),  
           div(style = "margin-left: 15px;", gt_output("table1")), 
           gt_output("table2")) 
    )
  )
)

server = function(input, output, session) {
  observeEvent(input$submit, {
  altplot <- ggplot(adlbaltfin, aes(x = WKVISIT, y = PERBASEavg, group = ARMCODE, color = ARMCODE)) +
     geom_errorbar(aes(ymin = PERBASEavg - SDavg, ymax = PERBASEavg + SDavg), width = .2) +
     geom_line() + 
     geom_point() +
     scale_color_brewer(palette = "Paired", name = "", labels = c("Placebo", "Treatment 1", "Treatment 2")) + theme_bw() +
     theme(axis.text.x = element_text(size = 10)) + 
     xlab("") +
     ylab("Mean Change from Baseline (95% CI)") +
     theme(axis.title.y = element_text(size = 12)) +
     theme(legend.position = "bottom") +
     geom_hline(yintercept = 0, linetype="dashed", color = "darkgrey") +
     ggtitle("Figure 3 \n Line Plot for Liver Biochemical Tests \n<Analysis Set>\nALT")
  
  astplot <- ggplot(adlbastfin, aes(x = WKVISIT, y = PERBASEavg, group = ARMCODE, color = ARMCODE)) +
     geom_errorbar(aes(ymin = PERBASEavg - SDavg, ymax = PERBASEavg + SDavg), width = .2) +
     geom_line() + 
     geom_point() +
     scale_color_brewer(palette = "Paired", name = "", labels = c("Placebo", "Treatment 1", "Treatment 2")) + theme_bw() +
     theme(axis.text.x = element_text(size = 10)) + 
     xlab("") +
     ylab("Mean Change from Baseline (95% CI)") +
     theme(axis.title.y = element_text(size = 12)) +
     theme(legend.position = "bottom") +
     geom_hline(yintercept = 0, linetype="dashed", color = "darkgrey") +
     ggtitle("Figure 3 \n Line Plot for Liver Biochemical Tests \n<Analysis Set>\nAST")
  
  tbiliplot <- ggplot(adlbtbilifin, aes(x = WKVISIT, y = PERBASEavg, group = ARMCODE, color = ARMCODE)) +
     geom_errorbar(aes(ymin = PERBASEavg - SDavg, ymax = PERBASEavg + SDavg), width = .2) +
     geom_line() + 
     geom_point() +
     scale_color_brewer(palette = "Paired", name = "", labels = c("Placebo", "Treatment 1", "Treatment 2")) + theme_bw() +
     theme(axis.text.x = element_text(size = 10)) + 
     xlab("") +
     ylab("Mean Change from Baseline (95% CI)") +
     theme(axis.title.y = element_text(size = 12)) +
     theme(legend.position = "bottom") +
     geom_hline(yintercept = 0, linetype="dashed", color = "darkgrey") +
     ggtitle("Figure 3 \n Line Plot for Liver Biochemical Tests \n <Analysis Set>\nTotal Bilirubin")
  
  alpplot <- ggplot(adlbalpfin, aes(x = WKVISIT, y = PERBASEavg, group = ARMCODE, color = ARMCODE)) +
     geom_errorbar(aes(ymin = PERBASEavg - SDavg, ymax = PERBASEavg + SDavg), width = .2) +
     geom_line() + 
     geom_point() +
     scale_color_brewer(palette = "Paired", name = "", labels = c("Placebo", "Treatment 1", "Treatment 2")) + theme_bw() +
     theme(axis.text.x = element_text(size = 10)) + 
     xlab("") +
     ylab("Mean Change from Baseline (95% CI)") +
     theme(axis.title.y = element_text(size = 12)) +
     theme(legend.position = "bottom") +
     geom_hline(yintercept = 0, linetype="dashed", color = "darkgrey") +
     ggtitle("Figure 3 \n Line Plot for Liver Biochemical Tests \n <Analysis Set>\nALP")

    output$linePlot = renderPlot({
    switch(isolate(input$Plot),
           "ALT" = altplot,
           "AST" = astplot,
           "Total Bilirubin" = tbiliplot,
           "ALP" = alpplot)
    })

    output$table1 = render_gt({
    switch(isolate(input$Plot),
           "ALT" = finalalttop,
           "AST" = finalasttop,
           "Total Bilirubin" = finaltbilitop,
           "ALP" = finalalptop
          )
    })
    
    output$table2 = render_gt({
    switch(isolate(input$Plot),
           "ALT" = finalaltbot,
           "AST" = finalastbot,
           "Total Bilirubin" = finaltbilibot,
           "ALP" = finalalpbot
          )
    })

})}

#Run the application 
shinyApp(ui = ui, server = server)
  </script>

  <script>
    (function(){
      let raw = document.getElementById('rawCode').textContent.replace(/\r/g, '').replace(/^\n+/, '').replace(/\n+$/, '');
      const linesArray = raw.split('\n');
      const linesContainer = document.getElementById('lines');
      const frag = document.createDocumentFragment();
      linesArray.forEach((text, idx) => {
        const row = document.createElement('div'); row.className='line';
        const ln = document.createElement('div'); ln.className='ln'; ln.textContent = idx+1;
        const content = document.createElement('div'); content.className='content'; content.textContent=text;
        row.appendChild(ln); row.appendChild(content); frag.appendChild(row);
      });
      linesContainer.appendChild(frag);

      document.getElementById('copyBtn').addEventListener('click', async ()=>{
        try {
          await navigator.clipboard.writeText(raw);
          let b=document.getElementById('copyBtn');
          b.textContent='Copied!';
          setTimeout(()=>b.textContent='Copy Code',1200);
        } catch(e) {
          alert('Copy failed');
        }
      });
    })();
  </script>
</body>
</html>
