---
title: "Table01"
format: live-html
engine: knitr
editor: visual
---

```{webr-r}
#| min-lines: 6
#| max-lines: 25
library(tidyverse)
library(magrittr)
library(tern)
library(dplyr)
library(r2rtf)
library(formatters)

#Load Insight Engineering's CADHY data to use as a dataset.
download.file(
  url = "https://raw.githubusercontent.com/phuse-org/hepatotox/main/cadhy.RData",
  destfile = "cadhy.RData",
  mode = "wb"   # important for binary files!
)

load("cadhy.RData")

#Set seed for reproducibility.#
set.seed(619)

#Removed any NA values. Also, added a record sequence number via RUNNUM.
adhy <- df_explicit_na(cadhy)
cadhy2 <- adhy %>% add_column(RUNNUM=runif(nrow(.)))

# Define values of interest in PARAMCD variable.
paramcd_tbili_alt <- c("BLAL", "BGAL", "BA2AL", "BA5AL")
paramcd_tbili_ast <- c("BLAS", "BGAS", "BA2AS", "BA5AS")
param_extra <- c("BL2AL2CB", "BL2AL2CU", "BL2AS2CB", "BL2AS2CU")

# Select laboratory test parameters.
adhy_liver_tot <- cadhy2 %>%
  filter(
    SAFFL == "Y",
    AVISIT %in% c("POST-BASELINE"),
    PARAMCD %in% c(paramcd_tbili_alt, paramcd_tbili_ast, param_extra),
    AVAL %in% c(0, 1, 2, 3, 4)
  )

#ADaM Programmers should have already included a variable
#similar to BIOCHEMREL & ADVREL that follow the metadata's criteria for findings
#related to biochemical tests & findings related to adverse events, respectively.
adhy_liver2 <- cadhy2 %>% mutate(BIOCHEMREL = ifelse(.8 > RUNNUM & RUNNUM > .5, 
                                                     "Yes", "No")) %>% 
  mutate(ADVREL = ifelse(.55 > RUNNUM & RUNNUM > .25, "Yes", "No")) %>% 
  filter(
    SAFFL == "Y",
    AVISIT %in% c("POST-BASELINE"),
    PARAMCD %in% c(paramcd_tbili_alt, paramcd_tbili_ast, param_extra),
    AVAL %in% c(1, 2, 3, 4)
  )

#Add appropriate labels for final table output.
adhy_liver3 <- adhy_liver2 %>% 
  mutate(FINBOTH = with_label(BIOCHEMREL == "Yes" &
                                ADVREL == "Yes", "Findings Related to Both Adverse Events and Biochemical Tests"),
         FINAEREL = with_label(ADVREL == "Yes", "Findings Related to Adverse Events"),
         FINBCTEST = with_label(BIOCHEMREL == "Yes", "Findings Related to Biochemical Tests")
  ) 

table(adhy_liver3$FINBOTH, adhy_liver3$ACTARM)
table(adhy_liver3$ACTARMCD, adhy_liver3$FINAEREL)

#Flag total number of findings without duplicates.
adhy_liver4 <- adhy_liver3 %>%                                                  
  mutate(TOP = case_when(ADVREL == "Yes" & BIOCHEMREL == "No"
                         & FINBOTH == "FALSE"~"Y", ADVREL == "No" & BIOCHEMREL == "Yes" & FINBOTH
                         == "FALSE"~"Y", .default = "N")) %>% 
  mutate(TABLESEQ = RUNNUM) %>% 
  mutate(FINTOP = with_label(TOP == "Y", "Any Potential Liver Safety Findings")) %>%
  mutate(ROWSPL1 = case_when(FINTOP == "FALSE" | FINTOP == "TRUE" ~ " ")) 

#Rename the treatment arms.
levels(adhy_liver4$ACTARMCD) <- c("T1", "PL", "T2")
levels(adhy_liver4$ACTARM) <- c("Treatment 1", "Placebo", "Treatment 2")

adhy_liver4$ACTARMCD <- factor(adhy_liver4$ACTARMCD,levels = c("PL", "T1", "T2")) 
aefin_vars <- c("FINBOTH", "FINAEREL", "FINBCTEST")

#Create a custom format function.
format_frac_perc <- function(x, output = NULL) {  
  # x[1] is N, x[2] is the % (as decimal)
  perc <- round(x[2] * 100, 1)
  denom <- (x[1] / (x[2] * 100)) * 100 # Calculate denominator
  paste0(x[1],"/", denom, " (", perc, "%)")
}

#Build & render table's pseudo facet 1a.
lyt_fin1a <- basic_table(show_colcounts = TRUE) %>% 
  split_rows_by(c("ROWSPL1")) %>%
  split_cols_by("ACTARMCD", split_fun = add_riskdiff(arm_x = c("T1"), arm_y = c("PL"), col_label = paste0("\n", "Risk", "\n", "Difference", "\n", 
 c("T1"), "-", c("PL"), "\n", "(95% CI)"))) %>% 
  count_patients_with_event(
    "TABLESEQ",
    filters = c("TOP"="Y"),
    denom = "N_col", riskdiff = TRUE,
    .labels = c(count_fraction = "Any Potential Liver Safety Findings"),
    .formats = c(count_fraction = format_frac_perc)) 

result_tabtop1a <- build_table(lyt_fin1a, df = adhy_liver4)
print(result_tabtop1a)

#Build & render table's pseudo facet 1b.
lyt_fin1b <- basic_table(show_colcounts = TRUE) %>% 
  split_rows_by(c("ROWSPL1")) %>%
  split_cols_by("ACTARMCD", split_fun = add_riskdiff(arm_x = c("T2"),
   arm_y = c("PL", "T1"), col_label = paste0("Risk", "\n", "Difference", 
   "\n", "T2-",  c("PL", "T1"), "\n", "(95% CI)"))) %>% 
  count_patients_with_event(
    "TABLESEQ",
    filters = c("TOP"="Y"),
    denom = "N_col", riskdiff = TRUE,
    .labels = c(count_fraction = "Any Potential Liver Safety Findings"),
    .formats = c(count_fraction = format_frac_perc))

result_tabtop1b <- build_table(lyt_fin1b, df = adhy_liver4)
print(result_tabtop1b)


#Bind specific columns from 2 top facets: 1a & 1b 1d.
resulttopfin <- cbind_rtables(result_tabtop1a[, 1:ncol(result_tabtop1a)], 
                              result_tabtop1b[, 4:ncol(result_tabtop1b)])

#Constructing & rendering the bottom half of the table: facet 2a.
lyt_fin2a <- basic_table(show_colcounts = TRUE) %>%
  split_cols_by("ACTARMCD", split_fun = add_riskdiff(arm_x = c("T1"), 
                                                     arm_y = c("PL"), col_label = paste0("\n", "Risk", "\n", "Difference", "\n", 
                                                                                         c("T1"), "-", c("PL"), "\n", "(95% CI)"))) %>%
  count_patients_with_flags(
    "RUNNUM",
    flag_variables = aefin_vars,
    denom = "N_col",
    var_labels = "",
    show_labels = "visible", 
    riskdiff = TRUE,
    .formats = c(count_fraction = format_frac_perc),
    .indent_mods = 1
  )

result_tabbot2a <- build_table(lyt_fin2a, df = adhy_liver4)

#Constructing & rendering the bottom half of the table: facet 2b.
lyt_fin2b <- basic_table(show_colcounts = TRUE) %>% 
  split_cols_by("ACTARMCD", split_fun = add_riskdiff(arm_x = c("T2"),
                                                     arm_y = c("PL", "T1"), col_label = paste0("Risk", "\n", "Difference", 
                                                                                               "\n", "T2-",  c("PL", "T1"), "\n", "(95% CI)"))) %>% 
  count_patients_with_flags(
    "RUNNUM",
    flag_variables = aefin_vars,
    denom = "N_col",
    var_labels = "",
    show_labels = "visible", 
    riskdiff = TRUE,
    .formats = c(count_fraction = format_frac_perc),
    .indent_mods = 
  )

result_tabbot2b <- build_table(lyt_fin2b, df = adhy_liver4)

#Bind specific columns from all 4 facets: 2a & 2b.
resultbot <- cbind_rtables(result_tabbot2a[, 1:ncol(result_tabbot2a)], 
                           result_tabbot2b[, 4:ncol(result_tabbot2b)])


#Bind specific rows from top & bottom halves of the table.
resultfin <- rbind(
  resulttopfin[nrow(resulttopfin), ],
  resultbot[3:nrow(resultbot), ],
  resultbot[2, ]
)

resultfin2 <- insert_rrow(resultfin, rrow("Number of Subjects with Liver\nSafety Findings(a)"), at = 1)

main_title(resultfin2) <- paste("Table 1", 
                                "\nOverview of Reported Potential Liver Safety Findings", "\n<Analysis Set>")
main_footer(resultfin2) <-paste("PL=Placebo, T1=Treatment 1, T2=Treatment 2",
                                "\nNote (a): A potential liver safety finding is defined as meeting any of the laboratory thresholds.",
                                "\nN = number of applicable subjects in treatment arm; n = actual applicable observed number with values.")

print(resultfin2) 

```
