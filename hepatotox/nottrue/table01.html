<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Interactive WebR Table 1</title>
<link href="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/themes/prism.min.css" rel="stylesheet" />
<style>
  body { font-family: Arial, sans-serif; padding: 20px; max-width: 1100px; margin: auto; }
  pre#webrCode {
    width: 100%;
    height: 400px;
    border: 1px solid #ccc;
    border-radius: 5px;
    padding: 10px;
    overflow: auto;
    background: #f0f0f0;
    color: #000;
    font-family: monospace;
    white-space: pre-wrap;
  }
  button { padding: 10px 20px; font-size: 16px; margin-top: 10px; }
  #output {
    display: flex;
    gap: 20px;
    margin-top: 10px;
  }
  #consoleOutput, #tableOutput {
    flex: 1;
    min-height: 100px;
    max-height: 600px;
    overflow-y: auto;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 5px;
    white-space: pre-wrap;
  }
  table {
    border-collapse: collapse;
    margin-top: 10px;
    width: 100%;
  }
  th, td {
    border: 1px solid #444;
    padding: 4px 8px;
    text-align: left;
  }
</style>
</head>
<body>

<h1>Interactive WebR Table 1</h1>

<pre id="webrCode" class="language-r">
load("cadhy.RData")
#Table 1 
#Install and upload appropriate packages. 
library(tidyverse) 
library(magrittr) 
library(tern) 
library(dplyr) 
library(rtables) 
library(formatters)
library(random.cdisc.data)
#Fetch dataset from github URL.
url <- "https://raw.githubusercontent.com/phuse-org/hepatotox/main/docs/data/cadhy.RData"
download.file(url, "cadhy.RData", mode = "wb")
load("cadhy.RData")
#Set seed for reproducibility.
set.seed(619)

#Removed any NA values. Also, added a record sequence number via RUNNUM. 
adhy <- df_explicit_na(cadhy) 
cadhy2 <- adhy %>% add_column(RUNNUM=runif(nrow(.)))

#Define values of interest in PARAMCD variable.
paramcd_tbili_alt <- c("BLAL", "BGAL", "BA2AL", "BA5AL") 
paramcd_tbili_ast <- c("BLAS", "BGAS", "BA2AS", "BA5AS")
param_extra <- c("BL2AL2CB", "BL2AL2CU", "BL2AS2CB", "BL2AS2CU")

#Select laboratory test parameters.

adhy_liver_tot <- cadhy2 %>% filter( SAFFL == "Y", AVISIT %in% c("POST-BASELINE"), 
PARAMCD %in% c(paramcd_tbili_alt, paramcd_tbili_ast, param_extra), AVAL 
%in% c(0, 1, 2, 3, 4) )

#ADaM Programmers should have already included a variable #similar to BIOCHEMREL & ADVREL that follow the metadata's criteria for findings related to biochemical tests & findings related to adverse events, respectively. 
adhy_liver2 <- cadhy2 %>% mutate(BIOCHEMREL = ifelse(.8 > RUNNUM & RUNNUM > .5, 
            "Yes", "No")) %>% mutate(ADVREL = ifelse(.55 > RUNNUM & RUNNUM > .25, "Yes", "No")) %>% 
	 filter( SAFFL == "Y", AVISIT %in% c("POST-BASELINE"), PARAMCD %in% c(paramcd_tbili_alt, paramcd_tbili_ast, param_extra), AVAL %in% c(1, 2, 3, 4) )

#Add appropriate labels for final table output. 
adhy_liver3 <- adhy_liver2 %>% mutate(FINBOTH = with_label(BIOCHEMREL == "Yes" & ADVREL == "Yes", " Findings Related to Both\n Adverse Events and Biochemical\n Tests"), FINAEREL = with_label(ADVREL == "Yes", " Findings Related to Adverse\n Events"), FINBCTEST = with_label(BIOCHEMREL == "Yes", " Findings Related to\n Biochemical Tests") )

#Flag total number of findings without duplicates. 
adhy_liver4 <- adhy_liver3 %>%mutate(TOP = case_when(ADVREL == "Yes" & BIOCHEMREL == "No" & FINBOTH == "FALSE"~"Y", ADVREL == "No" & BIOCHEMREL == "Yes" & FINBOTH == "FALSE"~"Y", .default = "N")) %>% mutate(TABLESEQ = RUNNUM) %>% mutate(FINTOP = with_label(TOP == "Y", "Any Potential Liver Safety Findings")) %>% mutate(ROWSPL1 = case_when(FINTOP == "FALSE" | FINTOP == "TRUE" ~ " "))

#Rename the treatment arms. levels(adhy_liver4$ACTARMCD) <- c("T1", "PL", "T2")
levels(adhy_liver4$ACTARM) <- c("T1\n n/N(%)", "PL\n n/N(%)", "T2\n n/N(%)")

adhy_liver4$ACTARMCD <- factor(adhy_liver4$ACTARMCD,levels = c("PL", "T1", "T2")) 
aefin_vars <- c("FINBOTH", "FINAEREL", "FINBCTEST")

#Create a custom format function. 
format_frac_perc <- function(x, output = NULL) {
    # x[1] is N, x[2] is the % (as decimal) 
  perc <- round(x[2] * 100, 1) 
    # Calculate denominator 
  denom <- (x[1] / (x[2] * 100)) * 100 
  paste0(x[1],"/", denom, " (", perc, "%)") }

#Build & render table's pseudo facet 1a. 
lyt_fin1a <- basic_table(show_colcounts = TRUE) %>% split_rows_by(c("ROWSPL1")) %>% split_cols_by("ACTARMCD", show_colcounts = TRUE, labels_var = "ACTARM", split_fun = add_riskdiff(arm_x = c("T1"), arm_y = c("PL"), col_label = paste0("\n", "Risk", "\n", "Difference", "\n", c("T1"), "-", c("PL"), "\n", "(95% CI)"))) %>% count_patients_with_event( "TABLESEQ", filters = c("TOP"="Y"), denom = "N_col", riskdiff = TRUE, .labels = c(count_fraction = "Any Potential Liver Safety Findings"), .formats = c(count_fraction = format_frac_perc))

result_tabtop1a <- build_table(lyt_fin1a, df = adhy_liver4)

#Build & render table's pseudo facet 1b. 
lyt_fin1b <- basic_table(show_colcounts = TRUE) %>% split_rows_by(c("ROWSPL1")) %>% split_cols_by("ACTARMCD", show_colcounts = TRUE, labels_var = "ACTARM", split_fun = add_riskdiff(arm_x = c("T2"), arm_y = c("PL", "T1"), col_label = paste0("Risk", "\n", "Difference", "\n", "T2-", c("PL", "T1"), "\n", "(95% CI)"))) %>% count_patients_with_event( "TABLESEQ", filters = c("TOP"="Y"), denom = "N_col", riskdiff = TRUE, .labels = c(count_fraction = "Any Potential Liver Safety Findings"), .formats = c(count_fraction = format_frac_perc))

result_tabtop1b <- build_table(lyt_fin1b, df = adhy_liver4)

#Bind specific columns from 2 top facets: 1a & 1b 1d. 
resulttopfin <- cbind_rtables(result_tabtop1a[, 1:ncol(result_tabtop1a)], result_tabtop1b[, 4:ncol(result_tabtop1b)])

#Constructing & rendering the bottom half of the table: facet 2a. 
lyt_fin2a <- basic_table(show_colcounts = TRUE) %>% split_cols_by("ACTARMCD", show_colcounts = TRUE, labels_var = "ACTARM", split_fun = add_riskdiff(arm_x = c("T1"), arm_y = c("PL"), col_label = paste0("\n", "Risk", "\n", "Difference", "\n", c("T1"), "-", c("PL"), "\n", "(95% CI)"))) %>% count_patients_with_flags( "RUNNUM", flag_variables = aefin_vars, denom = "N_col", var_labels = "", show_labels = "visible", riskdiff = TRUE, .formats = c(count_fraction = format_frac_perc), .indent_mods = 1 )

result_tabbot2a <- build_table(lyt_fin2a, df = adhy_liver4)

#Constructing & rendering the bottom half of the table: facet 2b. 
lyt_fin2b <- basic_table(show_colcounts = TRUE) %>% split_cols_by("ACTARMCD", show_colcounts = TRUE, labels_var = "ACTARM", split_fun = add_riskdiff(arm_x = c("T2"), arm_y = c("PL", "T1"), col_label = paste0("Risk", "\n", "Difference", "\n", "T2-", c("PL", "T1"), "\n", "(95% CI)"))) %>% count_patients_with_flags( "RUNNUM", flag_variables = aefin_vars, denom = "N_col", var_labels = "", show_labels = "visible", riskdiff = TRUE, .formats = c(count_fraction = format_frac_perc), .indent_mods = )

result_tabbot2b <- build_table(lyt_fin2b, df = adhy_liver4)

#Bind specific columns from all 4 facets: 2a & 2b. 
resultbot <- cbind_rtables(result_tabbot2a[, 1:ncol(result_tabbot2a)], result_tabbot2b[, 4:ncol(result_tabbot2b)])

resultbot

#Bind specific rows from top & bottom halves of the table. 
resultfin <- rbind( resulttopfin[nrow(resulttopfin), ], resultbot[3:nrow(resultbot), ], resultbot[2, ] )

resultfin2 <- insert_rrow(resultfin, rrow("Number of Subjects with Liver\nSafety Findings(a)"), at = 1)

main_title(resultfin2) <- paste("Table 1", "\nOverview of Reported Potential Liver Safety Findings", "\n<Analysis Set>")
main_footer(resultfin2) <-paste("PL=Placebo, T1=Treatment 1, T2=Treatment 2", "\nNote (a): A potential liver safety finding is defined as meeting any of the laboratory thresholds.", "\nN = number of applicable subjects in treatment arm; n = actual applicable observed number with values.")
resultfin2
</pre>

<button id="runBtn" disabled>Run Code</button>

<h2>Output:</h2>
<div id="output">
  <div id="consoleOutput">Initializing WebR...</div>
  <div id="tableOutput"><em>Table preview (only for data.frame/tibble)</em></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.30.0/components/prism-r.min.js"></script>
<script type="module">
import { WebR } from "https://webr.r-wasm.org/latest/webr.mjs";

const webr = new WebR();
const consoleDiv = document.getElementById("consoleOutput");
const tableDiv = document.getElementById("tableOutput");
const runBtn = document.getElementById("runBtn");

async function loadRDataFile(url, destName) {
  const resp = await fetch(url);
  const buf = await resp.arrayBuffer();
  const bytes = new Uint8Array(buf);
  webr.FS.writeFile(destName, bytes);
}

async function initializeWebR() {
  consoleDiv.textContent = "⏳ Starting WebR...";
  try {
    await webr.init({ onProgress: (msg) => consoleDiv.textContent = "⏳ " + msg });

    // List of required packages
    const pkgs = [
      "tidyverse","magrittr","tern","dplyr","rtables","r2rtf","formatters",
      "random.cdisc.data","tibble","tidyr","stringr","forcats","readr","jsonlite"
    ];

    // Install packages one by one with feedback
    consoleDiv.textContent = "⏳ Installing required R packages...\n";
    for (const pkg of pkgs) {
      consoleDiv.textContent += `Installing ${pkg}...\n`;
      await webr.evalR(`webr::install("${pkg}")`);
      await webr.evalR(`suppressPackageStartupMessages(library(${pkg}))`);
      consoleDiv.textContent += `✅ Loaded ${pkg}\n`;
    }

    // Load .RData into FS
    await loadRDataFile(
      "https://raw.githubusercontent.com/phuse-org/hepatotox/main/docs/data/cadhy.RData",
      "cadhy.RData"
    );

    consoleDiv.textContent += "✅ WebR initialized (packages and data loaded).\n";
    runBtn.disabled = false;
  } catch (err) {
    consoleDiv.textContent = "❌ WebR failed to init: " + err;
  }
}

runBtn.addEventListener("click", async () => {
  consoleDiv.textContent = "Running code...\n";
  tableDiv.innerHTML = "<em>Table preview (only for data.frame/tibble)</em>";
  const code = document.getElementById("webrCode").textContent.trim();

  const wrappedCode = `
    tryCatch({
      { ${code} } -> .last_val;
      .last_val
    }, error = function(e) {
      print(paste("❌ ERROR:", e$message))
      NULL
    })
  `;

  try {
    // Capture console output
    const result = await webr.evalR(wrappedCode, { captureStreams: true });
    const textOut = await result.toString();
    consoleDiv.textContent = textOut || "✅ Code ran successfully (no console output)";

    // Detect data.frame or tibble
    const isDfOrTibble = await webr.evalR(
      "is.data.frame(.last_val) || inherits(.last_val, 'tbl_df')"
    ).then(r => r.toBoolean());

    if (isDfOrTibble) {
      const jsonRes = await webr.evalR("jsonlite::toJSON(.last_val, dataframe='rows')");
      const jsonVec = (await jsonRes.toJs()).values;
      const jsonStr = Array.isArray(jsonVec) ? jsonVec.join("") : jsonVec;
      const rows = JSON.parse(jsonStr);

      let tableHtml = "<table><thead><tr>";
      if (rows.length > 0) {
        Object.keys(rows[0]).forEach(col => {
          tableHtml += `<th>${col}</th>`;
        });
        tableHtml += "</tr></thead><tbody>";
        rows.forEach(row => {
          tableHtml += "<tr>";
          Object.values(row).forEach(val => {
            tableHtml += `<td>${val}</td>`;
          });
          tableHtml += "</tr>";
        });
        tableHtml += "</tbody></table>";
      } else {
        tableHtml = "<p><em>Empty data frame/tibble</em></p>";
      }

      tableDiv.innerHTML = tableHtml;
    }
  } catch (err) {
    consoleDiv.textContent = "ERROR: " + err;
  }
});

initializeWebR();
</script>

</body>
</html>
